/*! jquery.valiant360 - v0.3.0 - 2014-09-16
 * http://flimshaw.github.io/Valiant360
 * Copyright (c) 2014 Charlie Hoey <me@charliehoey.com>; Licensed MIT */

var Detector={canvas:!!window.CanvasRenderingContext2D,webgl:function(){try{var a=document.createElement("canvas");return!!window.WebGLRenderingContext&&(a.getContext("webgl")||a.getContext("experimental-webgl"))}catch(b){return!1}}(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,getWebGLErrorMessage:function(){var a=document.createElement("div");return a.id="webgl-error-message",a.style.fontFamily="monospace",a.style.fontSize="13px",a.style.fontWeight="normal",a.style.textAlign="center",a.style.background="#fff",a.style.color="#000",a.style.padding="1.5em",a.style.width="400px",a.style.margin="5em auto 0",this.webgl||(a.innerHTML=window.WebGLRenderingContext?['Your graphics card does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br />','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n"):['Your browser does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br/>','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n")),a},addGetWebGLMessage:function(a){var b,c,d;a=a||{},b=void 0!==a.parent?a.parent:document.body,c=void 0!==a.id?a.id:"oldie",d=Detector.getWebGLErrorMessage(),d.id=c,b.appendChild(d)}};!function(a,b,c,d,e,f){function g(b,c){this.element=b,this.options=a.extend({},i,c),this._defaults=i,this._name=h,this.init()}var h="Valiant360",i={clickAndDrag:!1,fov:35,hideControls:!1,lon:0,lat:0,loop:"loop",muted:!0,debug:!1,flatProjection:!1,autoplay:!0};g.prototype={init:function(){this._time=(new Date).getTime(),this._controls={},this._id=this.generateUUID(),this._isVideo=!1,this._isPhoto=!1,this._isFullscreen=!1,this._mouseDown=!1,this._dragStart={},this._lat=this.options.lat,this._lon=this.options.lon,this._fov=this.options.fov,this._originalWidth=a(this.element).find("canvas").width(),this._originalHeight=a(this.element).find("canvas").height(),a(this.element).addClass("Valiant360_default"),this.createMediaPlayer(),this.createControls()},generateUUID:function(){var a=(new Date).getTime(),b="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(b){var c=(a+16*Math.random())%16|0;return a=Math.floor(a/16),("x"===b?c:7&c|8).toString(16)});return b},createMediaPlayer:function(){if(this._scene=new b.Scene,this._camera=new b.PerspectiveCamera(this.options.fov,a(this.element).width()/a(this.element).height(),.1,1e3),this._renderer=c.webgl?new b.WebGLRenderer:new b.CanvasRenderer,this._renderer.setSize(a(this.element).width(),a(this.element).height()),this._renderer.autoClear=!1,this._renderer.setClearColor(3355443,1),a(this.element).append(this._renderer.domElement),a(this.element).attr("data-photo-src"))this._isPhoto=!0,this._texture=b.ImageUtils.loadTexture(a(this.element).attr("data-photo-src"));else{this._isVideo=!0,this._video=e.createElement("video"),this._video.style.display="none",a(this.element).append(this._video),this._video.loop=this.options.loop,this._video.muted=this.options.muted,this._texture=new b.Texture(this._video);var d=this;this._video.addEventListener("ended",function(){}),this._video.addEventListener("progress",function(){var a=null;d._video&&d._video.buffered&&d._video.buffered.length>0&&d._video.buffered.end&&d._video.duration?a=d._video.buffered.end(0)/d._video.duration:d._video&&d._video.bytesTotal!==f&&d._video.bytesTotal>0&&d._video.bufferedBytes!==f&&(a=d._video.bufferedBytes/d._video.bytesTotal);Math.round(100*a)}),this._video.addEventListener("canplaythrough",function(){d.options.autoplay===!0&&(d._video.play(),d._videoReady=!0)}),this._video.src=a(this.element).attr("data-video-src")}this._texture.generateMipmaps=!1,this._texture.minFilter=b.LinearFilter,this._texture.magFilter=b.LinearFilter,this._texture.format=b.RGBFormat,this._mesh=new b.Mesh(new b.SphereGeometry(500,80,50),new b.MeshBasicMaterial({map:this._texture})),this._mesh.scale.x=-1,this._scene.add(this._mesh),this.animate()},createControls:function(){var b=this.options.muted?"fa-volume-off":"fa-volume-up",c=this.options.autoplay?"fa-pause":"fa-play",d='                 <div class="controls">                     <a href="#" class="playButton button fa '+c+'"></a>                     <a href="#" class="muteButton button fa '+b+'"></a>                     <a href="#" class="fullscreenButton button fa fa-expand"></a>                 </div>             ';a(this.element).append(d,!0),this.options.hideControls&&a(this.element).find(".controls").hide(),this.attachControlEvents()},attachControlEvents:function(){var b=this;this.element.addEventListener("mousemove",this.onMouseMove.bind(this),!1),this.element.addEventListener("mousewheel",this.onMouseWheel.bind(this),!1),this.element.addEventListener("DOMMouseScroll",this.onMouseWheel.bind(this),!1),this.element.addEventListener("mousedown",this.onMouseDown.bind(this),!1),this.element.addEventListener("mouseup",this.onMouseUp.bind(this),!1),a(e).on("webkitfullscreenchange mozfullscreenchange fullscreenchange",this.fullscreen.bind(this)),a(d).resize(function(){b.resizeGL(a(b.element).width(),a(b.element).height())}),a(this.element).find(".playButton").click(function(c){c.preventDefault(),a(this).hasClass("fa-pause")?(a(this).removeClass("fa-pause").addClass("fa-play"),b.pause()):(a(this).removeClass("fa-play").addClass("fa-pause"),b.play())}),a(this.element).find(".fullscreenButton").click(function(c){c.preventDefault();var d=a(b.element)[0];a(this).hasClass("fa-expand")?d.requestFullscreen?d.requestFullscreen():d.msRequestFullscreen?d.msRequestFullscreen():d.mozRequestFullScreen?d.mozRequestFullScreen():d.webkitRequestFullscreen&&d.webkitRequestFullscreen():d.requestFullscreen?e.exitFullscreen():d.msRequestFullscreen?e.msExitFullscreen():d.mozRequestFullScreen?e.mozCancelFullScreen():d.webkitRequestFullscreen&&e.webkitExitFullscreen()}),a(this.element).find(".muteButton").click(function(c){c.preventDefault(),a(this).hasClass("fa-volume-off")?(a(this).removeClass("fa-volume-off").addClass("fa-volume-up"),b._video.muted=!1):(a(this).removeClass("fa-volume-up").addClass("fa-volume-off"),b._video.muted=!0)})},onMouseMove:function(){this._onPointerDownPointerX=event.clientX,this._onPointerDownPointerY=-event.clientY,this._onPointerDownLon=this._lon,this._onPointerDownLat=this._lat;var b,c;this.options.clickAndDrag?this._mouseDown&&(b=event.pageX-this._dragStart.x,c=event.pageY-this._dragStart.y,this._dragStart.x=event.pageX,this._dragStart.y=event.pageY,this._lon+=b,this._lat-=c):(b=event.pageX-a(this.element).find("canvas").offset().left,c=event.pageY-a(this.element).find("canvas").offset().top,this._lon=b/a(this.element).find("canvas").width()*430-225,this._lat=c/a(this.element).find("canvas").height()*-180+90)},onMouseWheel:function(a){var b=-.01;a.wheelDeltaY?this._fov-=a.wheelDeltaY*b:a.wheelDelta?this._fov-=a.wheelDelta*b:a.detail&&(this._fov+=1*a.detail);var c=3,d=100;this._fov<c?this._fov=c:this._fov>d&&(this._fov=d),this._camera.setLens(this._fov),a.preventDefault()},onMouseDown:function(a){this._mouseDown=!0,this._dragStart.x=a.pageX,this._dragStart.y=a.pageY},onMouseUp:function(){this._mouseDown=!1},animate:function(){if(requestAnimationFrame(this.animate.bind(this)),this._isVideo&&this._video.readyState===this._video.HAVE_ENOUGH_DATA&&"undefined"!=typeof this._texture){var a=(new Date).getTime();a-this._time>=30&&(this._texture.needsUpdate=!0,this._time=a)}this.render()},render:function(){this._lat=Math.max(-85,Math.min(85,this._lat)),this._phi=(90-this._lat)*Math.PI/180,this._theta=this._lon*Math.PI/180;var a=500*Math.sin(this._phi)*Math.cos(this._theta),c=500*Math.cos(this._phi),d=500*Math.sin(this._phi)*Math.sin(this._theta);this._camera.lookAt(new b.Vector3(a,c,d)),this.options.flatProjection?(this._camera.position.x=0,this._camera.position.y=0,this._camera.position.z=0):(this._camera.position.x=-a,this._camera.position.y=-c,this._camera.position.z=-d),this._renderer.clear(),this._renderer.render(this._scene,this._camera)},play:function(){this._video.play()},pause:function(){this._video.pause()},loadVideo:function(a){this._video.src=a},loadPhoto:function(a){this._texture=b.ImageUtils.loadTexture(a)},fullscreen:function(){!d.screenTop&&!d.screenY&&a(this.element).find("a.fa-expand").length>0?(this.resizeGL(screen.width,screen.height),a(this.element).addClass("fullscreen"),a(this.element).find("a.fa-expand").removeClass("fa-expand").addClass("fa-compress"),this._isFullscreen=!0):(this.resizeGL(this._originalWidth,this._originalHeight),a(this.element).removeClass("fullscreen"),a(this.element).find("a.fa-compress").removeClass("fa-compress").addClass("fa-expand"),this._isFullscreen=!1)},resizeGL:function(a,b){this._renderer.setSize(a,b),this._camera.aspect=a/b,this._camera.updateProjectionMatrix()}},a.fn[h]=function(b){return this.each(function(){a.data(this,"plugin_"+h)||a.data(this,"plugin_"+h,new g(this,b))})}}(jQuery,THREE,Detector,window,document);